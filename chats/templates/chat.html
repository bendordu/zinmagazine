{% extends "shop/bas.html" %}
{% load static %}
{% block title %}{{ chat.name }}{% endblock %}
{% block content %}   

<div class="messages">

    {% for message_text in messages_text %}
    <div class="message">

        <div class="info">
            <span>{{ message_text.author }} {{ message_text.pub_date|date:"d.m.Y H:i" }}</span>
        </div>
        {% if message_text.author == request.user %}
        <div class="change">
            <a href="" data-id="{{ message_text.id }}" data-action="remove" class="remove">удалить</a>
            <a href="" data-name="{{ chat.name }}" data-action="edit" class="edit">редактировать</a>
        </div>
        {% endif %}
        <span class="body">{{ message_text.message }}</span>

    </div>
    {% endfor %}

    <div class="new_message"></div>
    
    <form class="message" method="post" data-name="{{ chat.name }}">
        <textarea name="body" cols="40" rows="2" required></textarea>
        <input class="message" type="file" title="Add image">
        <input type="submit" value="Send">
    </form>

</div>

{% endblock %} 

{% block domready %}

$('form.message').on("submit", function(e){
	e.preventDefault();
	$.post('{% url "chats:message_add" %}',
		{
		name: $(this).data('name'),
		data: $('form.message textarea').val(),
		},
		function(data){
			if (data['status'] == 'ok')
			{
				var name = $('a.name').text();
				var myDate = new Date();
				var fullDate = myDate.getDate() +" "+ myDate.getMonth() +" " + myDate.getFullYear();
				$('div.new_message').replaceWith('<div class="message"><div class="info">'+name+' '+fullDate+'</div><div>'+$('form.message textarea').val()+'</div></div><div class="new_message"></div>');
				$('form.message textarea').val('')
			}
		});
    });

$('div.change a.remove').click(function(e){
    e.preventDefault();
    var remove = event.target;
    $.post('{% url "chats:message_remove" %}',
        {
        id: $(remove).data('id'),
        action: $(remove).data('action'),
        },
        function(data){
            if (data['status'] == 'ok')
            {
                var parent = $(remove).parent('.change').parent('.message');
                parent.replaceWith('<p>Ваше сообщение удалено</p>');
            }
        });
    });
    
{% endblock %}