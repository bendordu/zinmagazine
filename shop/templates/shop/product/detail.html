{% extends "shop/bas.html" %}
{% load static %}
{% block title %}{{ product.name }}{% endblock %}
{% block content %} 

<div class="pr">
	<div class="product">
		
		<div class="product_detail">
			<div class="product_detail_title">
				<p class="product_detail_title_name">{{ product.name }}</p>
				<div class="product_detail_title_inf">
					<p class="product_detail_title_author">{{ product.author_product }}</p>
					<p class="product_detail_title_publisher">{{ product.publisher }}{% if product.publisher and product.year %}, {% endif %}{{ product.year }}</p>
				</div>
			</div>
			<div class="product_detail_info">

				{% if product.price_type.id == 1 %}
					{% if product.quantity_pr > 0 %}

						<span>{{ product.price }} RUB</span>
						<!--Q{{ product.quantity_pr }}
						заказали {{ product.count_order }}-->
						{% if product in cart.value or product in cart_user.products %}
						<a class="added_to_cart" href="{% url "cart:cart_detail" %}">
							<button>
								добавлено в корзину
							</button>
						</a>
						{% else %}

							<button class="add" data-id="{{ product.id }}" data-action="{% if product in cart.value %}cart{% endif %}add">
								в корзину
							</button> 

						{% endif %} 
					{% else %}

						<span>Товара нет в наличии</span>
						
					{% endif %}
				{% endif %}

				{% if product.price_type.id == 3 %}
					<span>от {{ product.price }} RUB</span> 
					<a href='{% if product.file_product %}{{ product.file_product.url }}{% endif %}'>
						<button class="download" data-id="{{ product.id }}">Скачать</button>
					</a>
				{% endif %}

			</div>

		</div>
			
		<div class="product_photo">
			{% if product.image %}
			<a href="#zatemnenie_image">
				<img class="product_photo_main" src="{{ product.image.url }}">
			</a>
			<div id="zatemnenie_image">
				<div class="image">
					<a href="#" class="dasboard_image_main_close">x</a>
					<img class="product_photo" src="{{ product.image.url }}">
				</div>
			</div>
			{% else %}
			<img class="product_photo_main" src="{% static "img/no_image.png" %}">
			{% endif %}

			<div class="product_photo_det">
				<div class="products_detail_btns_like_prev">
					{% if product.image_dop1 %}
					<img class="product_photo_dop" src="{% if product.image_dop1 %}{{ product.image_dop1.url }}{% else %}{% static "img/no_image.png" %}{% endif %}">
					{% endif %}
					{% if product.image_dop2 %}
					<img class="product_photo_dop" src="{% if product.image_dop2 %}{{ product.image_dop2.url }}{% else %}{% static "img/no_image.png" %}{% endif %}">
					{% endif %}
				</div>
			
				<div class="products_detail_btns_like">

					[<span class="{{ product.id }}">{{ product.users_like.count }}</span>]

					{% if request.user not in product.users_like.all %}
						<svg class="products_detail_btns_like_btn" viewBox="0 0 512 512"><path data-id="{{ product.id }}" data-action="{% if request.user in product.users_like.all %}un{% endif %}like"  d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>
					{% else %}
						<svg class="products_detail_btns_like_btn_selected" viewBox="0 0 512 512"><path data-id="{{ product.id }}" data-action="{% if request.user in product.users_like.all %}un{% endif %}like" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>
					{% endif %}
					
				</div>
			</div>
		</div>

	</div>

	

	<div class="product_descr">
		<span class="descr">Описание</span>
		<span class="body">{{ product.description|linebreaks }}</span>	
	</div>

</div>

	

	<!--

	<div class="product_detail_title_category">
		{% for category in product.category.all %}
			<a href="{{ category.get_absolute_url }}">{{ category }}</a>
		{% endfor %}
			<a href="{{ product.type_pr.get_absolute_url }}">{{ product.type_pr }}</a>
	</div>

{% if product.type_pr.id == 1 %}
<div class="product_detail_btns_bye">
	<span>
		[<span class='bye_paper{{ product.id }}'>
			{{ product.bye_paper.count }}
		</span>]
		человек хотят купить бумажную версию.
		{% if request.user not in product.bye_paper.all %}
		<span class="paper_want">А вы?</span>
		{% else %}
		<span class="paper_want">Мы оповестим, если она появится.</span>
		{% endif %} 
	</span>
	
	<div class="product_detail_btns_bye_paper">
		<button data-id="{{ product.id }}" data-action="{% if request.user in product.bye_paper.all %}un{% endif %}bye_paper" class="bye_paper">
			{% if request.user not in product.bye_paper.all %}
				{% if request.user.is_authenticated %}
					хочу!
				{% else %}
					хочу!
				{% endif %}
			{% else %}
				отменить
			{% endif %}
		</button>
	</div> 
</div>
{% endif %}-->


<div class="product_comment">
	<span class="product_comment_count"><span class="product_comment_count_comments">{{ comments.count }}</span> comment{{ comments.count|pluralize }}</span>

	{% for comment in comments %}
	<div class="product_comment_info">

		<div class="product_comment_info_dop">
			<span>{{ comment.author.username }} {{ comment.created|date:"d.m.Y H:i" }}</span>

			<div class="comment-like">
				{% if request.user not in comment.comment_likes.all %}
						<svg class="product_comment_svg" viewBox="0 0 512 512"><path data-id="{{ comment.id }}" data-action="{% if request.user in comment.comment_likes.all %}un{% endif %}like"  d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>
					{% else %}
						<svg class="product_comment_svg_selected" viewBox="0 0 512 512"><path data-id="{{ comment.id }}" data-action="{% if request.user in comment.comment_likes.all %}un{% endif %}like" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>
				{% endif %}
				<span class="comment{{ comment.id }}">{{ comment.comment_likes.count }}</span>
			</div>

			{% if comment.author == request.user %}
				<div>
					<a href="" data-id="{{ comment.id }}" data-action="remove" class="remove">удалить</a>
					<a href="" data-id="{{ comment.id }}" data-action="edit" class="edit">редактировать</a>
				</div>
			{% endif %}
		</div>

		<p class="product_comment_info_body_{{ comment.id }}">{{ comment.body }}</p>
		<button class="ok" hidden>ok</button>
		<button class="cancel" hidden>отмена</button>
		<div class="product_comment_ims">
			{% if comment.image0 %}
			<div class="product_comment_im">
				<button hidden id="close_{{ comment.id }}" data-image="image0"></button>
				<img class="product_photo_comment" src="{{ comment.image0.url }}">
			</div>
			{% endif %}
			{% if comment.image1 %}
			<div class="product_comment_im">
				<button hidden id="close_{{ comment.id }}" data-image="image1"></button>
				<img class="product_photo_comment" src="{{ comment.image1.url }}">
			</div>
			{% endif %}
			{% if comment.image2 %}
			<div class="product_comment_im">
				<button hidden id="close_{{ comment.id }}" data-image="image2"></button>
				<img class="product_photo_comment" src="{{ comment.image2.url }}">
			</div>
			{% endif %}
		</div>
		
	</div>
	
	{% endfor %}
	
	<div class="new_comment"></div>

	<div class="product_comment_form">

		<form class="comment" method="post" data-id="{{ product.id }}">
			<textarea placeholder="Напишите комментарий здесь..." rows="3" required></textarea>
			<input multiple type="file" name="image[]" accept="image/*" id="id_image" enctype="multipart/form-data">
			<div id="preview">
				<label class="form_add_image_btn" for="id_image"><span>Файл</span></label>
			</div>
			<button type="submit">отправить</button>
		</form>
	</div>

	<div class="form_add_image">
		<div id="prev" hidden>
			<span id="images_count"></span>
		</div>
	</div>

</div>
{% endblock %}  

{% block domready %}

$('div.products_detail_btns_like path').click(function(e){
    e.preventDefault();
    var product_like = event.target;
    $.post('{% url "likes:product_like" %}',
        {
        id: $(product_like).data('id'),
        action: $(product_like).data('action')
        },
        function(data){
            if (data['status'] == 'ok')
            {
                var previous_action = $(product_like).data('action');
                var pr_id = $(product_like).data('id');
  
                $(product_like).data('action', previous_action == 'like' ? 'unlike' : 'like');
                $(product_like).text(previous_action == 'like' ? $(product_like).css("fill", "#9d2c2c") : $(product_like).css("fill", "#dcdcdc"));
                
                var previous_likes = parseInt($('span.' + pr_id).text());
                $('span.' + pr_id).text(previous_action == 'like' ? previous_likes + 1 : previous_likes - 1);

                var previous_liked = parseInt($('a.navbar_btns_likes span').text());
				$('a.navbar_btns_likes span').text(previous_action == 'like' ? previous_liked + 1 : previous_liked - 1);
				$('a.navbar_btns_likes span').removeAttr('hidden');
            }
        });
    });

$('button.add').click(function(e){
	e.preventDefault();
	var product_add = event.target;
	$.post('{% url "cart:cart_add_product" %}',
		{
		id: $(product_add).data('id'),
		action: $(product_add).data('action'),
		},
		function(data){
			if (data['status'] == 'ok')
			{
				$(product_add).replaceWith('<a href="{% url "cart:cart_detail" %}"><button>добавлено в корзину</button></a>');  
				
				var previous_add = parseInt($('a.navbar_btns_cart span').text());
				$('a.navbar_btns_cart span').text(previous_add + 1);
				$('a.navbar_btns_cart span').removeAttr('hidden');
                if (parseInt($('a.navbar_btns_cart span').text()) > 1) 
                {
                    $('a.navbar_btns_cart span').replaceWith('<span>' + $('a.navbar_btns_cart span').text() + '</span>');
                }
                else {
                    $('a.navbar_btns_cart span').replaceWith('[<span>' + $('a.navbar_btns_cart span').text() + '</span>]');
                }
			}
		});
	});

var images = new Set();	

function showFile(e) {
	let files = e.target.files;
	if (files.length <= 3) {
		for (var i = 0, f; f = files[i]; i++) {

			var fr = new FileReader();
			if (images.size < 3) {
				images.add(f);
				
				fr.onload = (function(theFile) {

					return function(e) {

						var div = document.createElement('div');
						div.innerHTML = "<img src='" + e.target.result + "' />";
						div.setAttribute("id", "image");
						button = document.createElement('button');
						button.setAttribute("id", "close");
						button.innerHTML = "x";
						div.insertBefore(button, null);
						document.getElementById('prev').insertBefore(div, null);
						document.getElementById('prev').hidden=false;
						document.getElementById('images_count').innerHTML = "выбрано [" + images.size + "/3]";

						$(button).click(function(e) {
							$(this).parent('div#image').detach();
							images.delete(theFile); 
							document.getElementById('images_count').innerHTML = "выбрано [" + images.size + "/3]";
						});
					};
				})(f);
				fr.readAsDataURL(f);
			} else {
                document.getElementById('images_count').innerHTML = "максимально [" + images.size + "]";
                console.log(images.size);
            };
		};
	} else {
        document.getElementById('prev').hidden = false;
        document.getElementById('prev').innerHTML = "<span>максимальное количество изображений: 3</span>";
    };
}
document.getElementById('id_image').addEventListener('change', showFile, true);

$('form.comment').on("submit", function(e){
	e.preventDefault();	
	document.getElementById('prev').hidden=true;

	var my_form = new FormData();
	my_form.append('id', $(this).data('id'));
	my_form.append('data', $('form.comment textarea').val());

	var files = Array.from(images);
	for (var i = 0; i < files.length; i++) {
		my_form.append('image'+i, files[i]);
	}
	images.clear();

	$.ajax({
        type: 'POST',
        url: "{% url "shop:product_add_comment" %}",
		data: my_form,
		enctype: 'multipart/form-data',
        processData: false, 
        contentType: false, 
        success: function(data) {
			if (data['status'] == 'ok')
			{
				var name = $('a.navbar_log_in_name').text()
				var myDate = new Date();
				var fullDate = myDate.getDate() + "." + myDate.getMonth() + "." + myDate.getFullYear();
				$('div.new_comment').replaceWith('<div class="product_comment_info"><span>'+name+' '+fullDate+'</span><div></div><p class="product_comment_info_body">'+$('form.comment textarea').val()+'</p></div><div class="new_comment"></div>');
				$('form.comment textarea').val('');
				$('span.product_comment_count_comments').text(parseInt($('span.product_comment_count_comments').text())+1)
			}
		}
		});
	});

$('form.comment').keypress(function(e) {
	if(e.which == 13) {
		e.preventDefault();
		$('form.comment').trigger("submit");
	}
});

$('.remove').click(function(e){
	e.preventDefault();
	var remove = e.target;
	$.post('{% url "shop:product_remove_comment" %}',
		{
		id: $(remove).data('id'),
		action: $(remove).data('action'),
		},
		function(data){
			if (data['status'] == 'ok')
			{
				var parent = $(remove).parent('div').parent('div').parent('.product_comment_info');
				parent.replaceWith('<p>Ваш комментарий удален</p>');
				$('span.product_comment_count_comments').text(parseInt($('span.product_comment_count_comments').text())-1)	
			}
		});
	});

$('.edit').click(function(e){
	e.preventDefault();
	var edit = e.target;

	$('.edit').hide();
	
	var body = $('.product_comment_info_body_' + $(edit).data('id'));
	var text = body.text();
	
	var ok = body.next('button.ok').show();
	$(ok).next('button.cancel').show();

	var textarea = document.createElement('textarea');
	textarea.innerHTML = text;
	body.replaceWith(textarea);

	$('button#close_' + $(edit).data('id')).show();

	$('button#close_' + $(edit).data('id')).click(function(e) {
		var close = e.target;
		$.post('{% url "shop:product_remove_comment" %}',
		{
			image: $(close).data('image'),
			id: $(edit).data('id'),
		},
		function(data){
			if (data['status'] == 'ok')
			{
				$(close).parent('div.product_comment_im').detach();
			}
		});
	});

	$('button.cancel').click(function(e) {
		$(textarea).replaceWith('<p class="product_comment_info_body_' + $(edit).data('id') + '">' + text + '</p>');
		$('.product_comment_ims #prev').hide();
		$('button.ok').hide();
		$('button#close_' + $(edit).data('id')).hide();
		$('button.cancel').hide();
		$('.edit').show();
	});

	$('button.ok').click(function(e) {
		$.post('{% url "shop:product_remove_comment" %}',
		{
		id: $(edit).data('id'),
		action: $(edit).data('action'),
		body: $(textarea).val(),
		},
		function(data){
			if (data['status'] == 'ok')
			{
				$(textarea).replaceWith('<p class="product_comment_info_body_' + $(edit).data('id') + '">' + $(textarea).val() + '</p>');
				$('.product_comment_ims #prev').hide();
				$('button.ok').hide();
				$('button#close_' + $(edit).data('id')).hide();
				$('button.cancel').hide();
				$('.edit').show();
			}
		});
	});
	});

$('button.bye_paper').click(function(e){
	e.preventDefault();
	var product_bye_paper = event.target;
	$.post('{% url "shop:product_bye_paper" %}',
		{
		id: $(product_bye_paper).data('id'),
		action: $(product_bye_paper).data('action')
		},
		function(data){
			if (data['status'] == 'ok')
			{
				var previous_action = $(product_bye_paper).data('action');
				var pr_id = $(product_bye_paper).data('id');
	
				$(product_bye_paper).data('action', previous_action == 'bye_paper' ? 'unbye_paper' : 'bye_paper');
				$(product_bye_paper).text(previous_action == 'bye_paper' ? 'отменить' : 'хочу!');
				$('span.paper_want').text(previous_action == 'bye_paper' ? 'Мы оповестим, если она появится.' : 'А вы?');
				
				var previous_bye_paper = parseInt($('span.' + 'bye_paper' + pr_id).text());
				$('span.' + 'bye_paper' + pr_id).text(previous_action == 'bye_paper' ? previous_bye_paper + 1 : previous_bye_paper - 1);
			}
		});
	});

$('div.comment-like path').click(function(e){
	e.preventDefault();
	var comment_like = event.target;
	$.post('{% url "shop:product_comment_like" %}',
		{
		id: $(comment_like).data('id'),
		action: $(comment_like).data('action')
		},
		function(data){
			if (data['status'] == 'ok')
			{
				var previous_action = $(comment_like).data('action');
				var id = $(comment_like).data('id');
	
				$(comment_like).data('action', previous_action == 'like' ? 'unlike' : 'like');
				$(comment_like).text(previous_action == 'like' ? $(comment_like).css("fill", "#000") : $(comment_like).css("fill", "#a1a1a1"));
				
				var previous_likes = parseInt($('span.comment' + id).text());
				$('span.comment' + id).text(previous_action == 'like' ? previous_likes + 1 : previous_likes - 1);
			}
		});
	});

$('button.download').click(function(e){
	e.preventDefault();
	$.post('{% url "shop:download_product" %}',
		{
		id: $(this).data('id'),
		});
	});

{% endblock %}
