{% extends "shop/bas.html" %}
{% load static %}
{% block title %}Bookmarks{% endblock %}
{% block content %} 

<div class="bookmarks">
{% if not bookmark_list %}

    <span>Пока здесь пусто...</span><a href="{% url "register" %}">зарегистрироваться</a>

    {% else %}

    <div class="bookmarks_list">
        {% for post in bookmark_list %}
        <div class='{{ post.title }}'>
            <a href="{{ post.get_absolute_url }}"><img src="{% if post.image %}{{ post.image.url }}{%else %}{% static "img/no_image.png" %}{% endif %}"></a>
            <a href="{{ post.get_absolute_url }}">{{ post.title }}</a><br>

            {% with total_bookmark=post.bookmark.count bookmark=post.bookmark.all %}

                <span class="{{ post.author }}">{{ total_bookmark }}</span>
                <button data-title="{{ post.title }}" data-author='{{ post.author }}' data-action="{% if request.user in bookmark %}un{% endif %}bookmark" class="bookmarkbutton">
                {% if request.user not in bookmark %}
                    bookmark
                {% else %}
                    unbookmark
                {% endif %}
                </button>
            
            {% endwith%}
        
        </div>
        {% endfor%}
        
    </div>

{% endif %}

</div>

{% endblock %}

{% block domready %}

$('button.bookmarkbutton').click(function(e){
	e.preventDefault();
	var bookmark = event.target;
	$.post('{% url "blog:bookmark" %}',
		{
		title: $(bookmark).data('title'),
		action: $(bookmark).data('action'),
		},
		function(data){
			if (data['status'] == 'ok')
			{
				var previous_action = $(bookmark).data('action');
				var title = $(bookmark).data('title');
				var author = $(bookmark).data('author');
	
				$(bookmark).data('action', previous_action == 'bookmark' ? 'unbookmark' : 'bookmark');
				$(bookmark).text(previous_action == 'bookmark' ? 'unbookmark' : 'bookmark');

                if (parseInt($('button.bookmark a').text()) > 1){
                    $('div.' + title).replaceWith('');  
                    
                    var previous_bookmark = parseInt($('button.bookmark a').text());
                    $('button.bookmark a').text(previous_bookmark - 1);
                }else{
                    var previous_bookmark = parseInt($('button.bookmark a').text());
                    $('button.bookmark a').text(previous_bookmark - 1);
                    $('div.bookmark_list').replaceWith('<h2>Теперь здесь пусто...</h2>'); 
                }
			}
		});
	});

{% endblock %}