{% extends "shop/bas.html" %}
{% load static %}
{% block title %}Корзина{% endblock %}
{% block content %} 

{% if cart|length > 0 %}

<div class="cart">
    <table class="cart_table">
        <tbody>
            {% for item in cart %}
            {% with product=item.product %}
            <tr class='{{ product.id }}'>
                <td class="cart_table_item">
                    <a href="{{ product.get_absolute_url }}">
                        <img src="{% if product.image %}{{ product.image.url }}{% else %}{% static "img/no_image.png" %}{% endif %}">
                    </a>
                    <a class="cart_table_item_name" href="{{ product.get_absolute_url }}">{{ product.name }}</a>
                </td>
                {% if product.available %}
                <td class="cart_table_btns">
                    <button class="minus" data-id="{{ product.id }}" data-action="minus">
                        -
                    </button> 
                    <span id='{{ product.id }}'>{{ item.quantity }}</span>
                    {% if product.quantity_pr > item.quantity %}
                    <button class="plus" id="plus__{{ product.id }}" data-id="{{ product.id }}" data-action="plus">
                        +
                    </button>
                    {% else %}
                    <div class="error_quantity__{{ product.id }}">{{ product.quantity_pr }} шт. в наличии</div>
                    {% endif %}
                    <button hidden class="plus" id="plus_{{ product.id }}" data-id="{{ product.id }}" data-action="plus">
                        +
                    </button>
                    <div hidden class="error_quantity_{{ product.id }}">{{ product.quantity_pr }} шт. в наличии</div>
                    <div hidden>
                        <span class="item_quantity_{{ product.id }}">{{ item.quantity }}</span>
                        <span class="product_quantity_pr_{{ product.id }}">{{ product.quantity_pr }}</span>
                    </div>
                </td>
                <td class='{{ product.id }}'><span class="item_price">{{ item.price }}</span> RUB/шт.</td>
                <td class='{{ product.id }}'>= <span class="item_total_price">{{ item.total_price }}</span> RUB</td>
                {% else %}
                <td><span>Товар больше недоступен</span></td>
                {% endif %}
                <td class="cart_table_remove">
                    <button class="remove" data-id="{{ product.id }}" data-action="remove">x</button>
                </td>
            </tr>
                {% endwith %}
                {% endfor %}
            <tr class="cart_table_total">
                <td colspan="5"></td>
                <td class="total">итого [ <span class="total_price">{{ cart.get_total_price }}</span> RUB ]</td>
            </tr>
            <tr>
                <td colspan="5"></td>
                <td class="cart_table_order"><a href="{% url "orders:order_create" %}"><button>оформить заказ</button></a></td>
            </tr>
        </tbody>
    </table>
</div>

{% else %}
<div class="cart">
    <span>Корзина пуста</span>
    <a href="{% url "shop:product_list" %}">продолжить покупки</a>
</div>
{% endif %}
                
{% endblock %}


{% block domready %}

$('button.plus').click(function(e){
    e.preventDefault();
    var product_add = event.target;
    $.post('{% url "cart:cart_add_product" %}',
        {
        id: $(product_add).data('id'),
        action: $(product_add).data('action'),
        },
        function(data){
            if (data['status'] == 'ok')
            { 
                var previous_add = parseInt($('a.navbar_btns_cart span').text());
                $('a.navbar_btns_cart span').text(previous_add + 1);

                var pr_id = $(product_add).data('id');

                var previous_add_quatity = parseInt($('span#' + pr_id).text());
                $('span#' + pr_id).text(previous_add_quatity + 1);

                var item_price = parseInt($('td.' + pr_id + ' ' + 'span.item_price').text());
                var total_price = parseInt($('span.total_price').text());
                ($('td.' + pr_id + ' ' + 'span.item_total_price').text(item_price +  parseInt($('td.' + pr_id + ' ' + 'span.item_total_price').text())));
                ($('span.total_price').text(total_price + item_price));

                var product_quantity_pr = parseInt($('span.product_quantity_pr_' + pr_id).text());
                $('span.item_quantity_' + pr_id).text( parseInt($('span.item_quantity_' + pr_id).text()) + 1);
                
                if (product_quantity_pr == parseInt($('span.item_quantity_' + pr_id).text())) {
                    $('button#plus_' + pr_id).hide();
                    $('button#plus__' + pr_id).hide();
                    $('div.error_quantity_' + pr_id).show();
                    $('div.error_quantity__' + pr_id).hide();
                }
            }
        });
    });

$('button.minus').click(function(e){
    e.preventDefault();
    var product_add = event.target;
    $.post('{% url "cart:cart_add_product" %}',
        {
        id: $(product_add).data('id'),
        action: $(product_add).data('action'),
        },
        function(data){
            if (data['status'] == 'ok')
            {
                var pr_id = $(product_add).data('id');
                var previous_add = parseInt($('a.navbar_btns_cart span').text());

                var product_quantity_pr = parseInt($('span.product_quantity_pr_' + pr_id).text());
                if (product_quantity_pr == parseInt($('span.item_quantity_' + pr_id).text())) {
                    $('button#plus_' + pr_id).show();
                    $('button#plus__' + pr_id).hide();
                    $('div.error_quantity_' + pr_id).hide();
                    $('div.error_quantity__' + pr_id).hide();
                }
                $('span.item_quantity_' + pr_id).text( parseInt($('span.item_quantity_' + pr_id).text()) - 1);
                
                if  (parseInt($('span#' + pr_id).text()) > 1){

                    $('a.navbar_btns_cart span').text(previous_add - 1);
                    $('span#' + pr_id).text(parseInt($('span#' + pr_id).text()) - 1);

                    var item_price = parseInt($('td.' + pr_id + ' ' + 'span.item_price').text());
                    var total_price = parseInt($('span.total_price').text());
                    ($('td.' + pr_id + ' ' + 'span.item_total_price').text(parseInt($('td.' + pr_id + ' ' + 'span.item_total_price').text()) - item_price));
                    ($('span.total_price').text(total_price - item_price));
                    
                }else{
                    if (parseInt($('a.navbar_btns_cart span').text()) > 1){
                        var item_price = parseInt($('td.' + pr_id + ' ' + 'span.item_price').text());
                        ($('span.total_price').text(parseInt($('span.total_price').text()) - item_price));
                        $('tr.' + pr_id).replaceWith(''); 
                        $('a.navbar_btns_cart span').text(previous_add - 1);   
                    }else{
                        var previous_add = parseInt($('a.navbar_btns_cart span').text());
                        var previous_quantity = parseInt($('span#' + pr_id).text());
                        $('a.navbar_btns_cart span').text(previous_add - previous_quantity);
                        $('div.cart').replaceWith('<div class="cart"><span>Теперь здесь пусто...</span><a href="{% url "shop:product_list" %}">продолжить покупки</a></div>'); 
                    }                 
                }
            }
        });
    });

$('button.remove').click(function(e){
    e.preventDefault();
    var product_remove = event.target;
    $.post('{% url "cart:cart_add_product" %}',
        {
        id: $(product_remove).data('id'),
        action: $(product_remove).data('action'),
        },
        function(data){
            if (data['status'] == 'ok')
            {
                var pr_id = $(product_remove).data('id');
                var previous_add = parseInt($('a.navbar_btns_cart span').text());
                var previous_quantity = parseInt($('span#' + pr_id).text());
                $('a.navbar_btns_cart span').text(previous_add - previous_quantity);

                if (parseInt($('a.navbar_btns_cart span').text()) > 0){

                    var item_total_price = parseInt($('td.' + pr_id + ' ' + 'span.item_total_price').text());
                    var total_price = parseInt($('span.total_price').text());
                    $('tr.' + pr_id).replaceWith(''); 
                    ($('span.total_price').text(total_price - item_total_price))

                }else{
                    $('div.cart').replaceWith('<div class="cart"><span>Теперь здесь пусто...</span><a href="{% url "shop:product_list" %}">продолжить покупки</a></div>'); 
                }
            }
        });
    });
{% endblock %}